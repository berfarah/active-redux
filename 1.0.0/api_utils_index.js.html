<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>api/utils/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="define-Model.html">Model</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="define-Model.html#.all">all</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="define-Model.html#.find">find</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="define-Model.html#.where">where</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-active-redux.html">active-redux</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux.html#.bind">bind</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux.html#.define">define</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-active-redux_api.html">active-redux/api</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_api.html#.apiConfigure">apiConfigure</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_api.html#.apiCreate">apiCreate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_api.html#.apiDelete">apiDelete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_api.html#.apiHydrate">apiHydrate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_api.html#.apiRead">apiRead</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_api.html#.apiUpdate">apiUpdate</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-active-redux_attributes.html">active-redux/attributes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_attributes.html#.array">array</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_attributes.html#.boolean">boolean</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_attributes.html#.date">date</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_attributes.html#.hasMany">hasMany</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_attributes.html#.hasOne">hasOne</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_attributes.html#.number">number</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_attributes.html#.object">object</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-active-redux_attributes.html#.string">string</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">api/utils/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import imm from 'object-path-immutable';
import Registry from '../../registry';
import '../../polyfill';

export apiClient from './api-client';

/**
 * @module
 * @private
 */

/**
 * @example
 * incrementProperty(state, 'isReading')
 * @param {Object} state Object on which the key is incremented
 * @param {string} key Key to increment
 */
export const incrementProperty = (state, key) => (
  imm.set(state, key, state[key] + 1)
);

/**
 * @example
 * decrementProperty(state, 'isReading')
 * @param {Object} state Object on which the key is decremented
 * @param {string} key Key to decrement
 */
export const decrementProperty = (state, key) => (
  imm.set(state, key, state[key] - 1)
);

/**
 * @param {Array|Object} data
 */
export const resourcesArray = (data = []) => (
  Array.isArray(data) ? data : [data]
);

/**
 * @example
 * const obj = { foo: bar: { baz: 'hi' } }
 * getProperty(obj, 'foo', 'bar', 'baz') // => 'hi'
 * getProperty(obj, 'a', 'b', 'c') // => undefined
 *
 * @param {Object} object Object to traverse
 * @param {String[]} keys Keys to look up
 */
export const getProperty = (object, ...keys) => (
  keys.reduce((acc, key) => {
    if (acc === undefined) return acc;
    return acc[key];
  }, object)
);

/**
 * Creates reverse relationships for data merged into the state
 * @param {Object} state
 * @param {Object} newState Immutable Object via object-path-immutable
 * @param {Object} data JSON-API data object
 * @param {Object} data.id
 * @param {Object} data.type
 * @param {Object} data.relationships
 */
export const createReverseRelationships = (state, newState, { id, type, relationships = {} }) => {
  Object.values(relationships).forEach(({ data }) => {
    const children = resourcesArray(data);
    const childModel = Registry.get(children[0].type);
    const childData = { type, id };
    const { key, isArray } = childModel.relationships[type];

    children.forEach(({ type: relType, id: relId }) => {
      const objectPath = ['resources', relType, relId, 'relationships', key];
      const existingRelationships = resourcesArray(getProperty(state, ...objectPath));

      if (!isArray) {
        newState.set([...objectPath, 'data'], childData);
        return;
      }

      if (existingRelationships.find((relationship) => relationship.id === id)) return;

      newState.push([...objectPath, 'data'], childData);
    });
  });
};

/**
 * Merges all resources into the state
 * @param {Object} state
 * @param {Object} payload JSON-API payload
 * @param {Object} payload.data
 * @param {Object} payload.included
 */
export const mergeResources = (state, { data, included = [] }) => {
  const newState = imm(state);

  resourcesArray(data).concat(included).forEach((dataObj) => {
    // if we don't do this and the ID is a number, it'll create an array
    newState.set(['resources', dataObj.type], state[dataObj.type] || {});
    newState.set(['resources', dataObj.type, dataObj.id], dataObj);
    createReverseRelationships(state, newState, dataObj);
  });

  return newState.value();
};

/**
 * This function clears differently based on what's passed in
 * Object: { type, id } -> this resource is cleared
 * Array: Each of the resources is cleared
 * String: '[type]' -> These resources are cleared
 * undefined: -> All resources are cleared
 * @param {Object} state
 * @param {Object[]|Object|string|undefined} data
 */
export const clearResources = (state, data) => {
  switch (typeof data) {
    case 'object': {
      if (Array.isArray(data)) return data.reduce(clearResources, state);
      const { type, id } = data;
      return imm.del(state, ['resources', type, id]);
    }
    case 'string': return imm.set(state, ['resources', data], {});
    case 'undefined': return imm.set(state, 'resources', {});
    default: return state;
  }
};

/**
 * @example
 * const CUSTOM_REDUX_ACTION = 'CUSTOM_REDUX_ACTION';
 * export const customReduxAction = createAction(CUSTOM_REDUX_ACTION); // => [function]
 * customReduxAction(payload) // => { type, payload }
 * @param {string} type Action type
 */
export const createAction = (type) => (payload) => ({ type, payload });

/**
 * @param {Object} mappings Reducer handlers per action
 * @param {Object} initialState
 */
export const createReducer = (mappings, initialState) => (state = initialState, action) => (
  mappings[action.type] ? mappings[action.type](state, action) : state
);

/**
 * @param {Object} state
 * @param {Object} resource
 * @param {Array|Object} resource.data
 */
export const markPendingResources = (state, { data }) => (
  resourcesArray(data).reduce((acc, resource) => {
    if (!getProperty(state, 'resources', resource.type, resource.id)) return acc;
    return acc.set(['resources', resource.type, resource.id, 'isPending'], true);
  }, imm(state)).value()
);
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Mon Aug 14 2017 17:37:51 GMT-0700 (PDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
